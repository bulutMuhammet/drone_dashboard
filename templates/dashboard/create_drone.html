{% extends "dashboard/layout.html" %}

{% block content %}
    <div class="dash-content ">
        <div class="row justify-content-center">
            <div id="message_div" class="mt-5 col-9">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="col-9  tabler mb-2 mt-1">
                <h4><b>Takımım</b>: {{ request.user.staff.team }}</h4>
            </div>
            <div class="col-9 tabler pb-5 mt-5">
                <h4 class="text-dark mt-5 mb-5 fw-bold">İHA Üret</h4>
                <form id="produce_form">
                    <label for="">İha Modeli</label>
                    <select name="drone_opt" id="drone_opt" class="form-select" required>
                        <option value="" selected disabled hidden>Seçiniz</option>
                    </select>
                    <span class="text-danger" id="stock_warning" hidden></span> <br>
                    <label for="" class="mt-3">Kullanıma Uygun Parçalar</label>
                    <select name="part_opt" id="part_opt" class="form-select" required multiple>

                    </select>
                    <button type="submit" class="btn btn-success col-12 mt-2">Üret</button>
                </form>

            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>


        $(document).ready(function () {
            var message_div = document.getElementById("message_div")
            var selected_drone

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            $.ajax({
                url: '/api/drone/',  // DRF API endpoint
                method: 'GET',
                success: function (data) {
                    const drone_select = $('#drone_opt');
                    data.forEach(function (drone) {
                        drone_select.append($('<option>', {
                            value: drone.id,
                            text: drone.name
                        }));
                    });

                },
                error: function (xhr, status, error) {

                    console.error('API request failed:', xhr);
                }
            });

            $("#produce_form").on("submit", function (e) {
                e.preventDefault()
                var selectedValues = $('#part_opt').val();
                if (selectedValues) {
                    selectedValues = selectedValues.map(function (value) {
                        return parseInt(value); // Tam sayıya dönüştürüyoruz
                    });
                }
                var csrftoken = getCookie('csrftoken');
                console.log(selectedValues)

                $.ajax({
                    url: '/api/drone/assemble/',  // DRF API endpoint
                    method: 'POST',
                    headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json"}, // CSRF token'ı başlıkta gönderin

                    data: JSON.stringify({
                        parts: selectedValues,
                        drone: selected_drone
                    }),
                    success: function (data) {
                        window.location = "/drone-list"

                    },
                    error: function (xhr, status, error) {
                        error = JSON.parse(xhr.responseText)
                        message_div.innerHTML = `<div class="alert alert-danger"> ${error.detail} </div>`

                        if (error.errors.missing_parts) message_div.innerHTML += `
                                <div class="alert alert-danger">
                                    Eksik parçalar, bu parçalar olmadan montaj yapılamaz <br>
                                    ${error.errors.missing_parts}
                                </div>`

                        if (error.errors.duplicated) message_div.innerHTML += `
                                <div class="alert alert-danger">
                                    ${error.errors.duplicated}
                                </div>`
                    }
                });
            })

            $("#drone_opt").on("change", function () {
                $('#part_opt').empty()
                var id = $(this).find(":selected").val()
                selected_drone = parseInt(id)
                var csrftoken = getCookie('csrftoken');
                var stock_warning = document.getElementById("stock_warning")

                $.ajax({
                    url: '/api/drone/assembly-stock-check/', // DRF API endpoint
                    method: 'POST',
                    headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json"}, // CSRF token'ı başlıkta gönderin
                    data: JSON.stringify({
                        drone_id: selected_drone
                    }),
                    success: function (data) {
                        stock_warning.hidden = true
                        $.ajax({
                        url: '/api/drone/parts/?page=1&page_size=100&is_used=false&drone=' + id,  // DRF API endpoint
                        method: 'GET',
                        success: function (data) {
                            const part_select = $('#part_opt');
                            data.results.forEach(function (part) {
                                part_select.append($('<option>', {
                                    value: part.id,
                                    text: part.part_name + "  |  " + part.serial_number
                                }));
                            });

                        },
                        error: function (xhr, status, error) {
                            console.error('API request failed:', error);
                        }
                    });

                    },
                    error: function (xhr, status, error) {
                        error = JSON.parse(xhr.responseText)
                        stock_warning.hidden = false
                        stock_warning.innerText = "Bu drone için bazı parçaların stoğu yok: " + error.needed_parts
                    }
                });
                
            })
        });
    </script>
{% endblock %}